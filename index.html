<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Momentum Machine</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Righteous&family=Archivo:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --bg-dark: #4a3f2e;
            --bg-card: #5c4f39;
            --accent-primary: #ff8c42;
            --accent-secondary: #ffb865;
            --accent-red: #fb2e01;
            --accent-teal: #6fcb9f;
            --text-primary: #fffeb3;
            --text-secondary: #ffb865;
            --border: #6b5d47;
            --success: #6fcb9f;
            --warning: #fb2e01;
        }

        body {
            font-family: 'Archivo', sans-serif;
            background: var(--bg-dark);
            color: var(--text-primary);
            min-height: 100vh;
            background-image: 
                radial-gradient(at 20% 30%, rgba(255, 140, 66, 0.12) 0px, transparent 50%),
                radial-gradient(at 80% 70%, rgba(255, 184, 101, 0.12) 0px, transparent 50%);
            padding: 1.5rem 1rem;
            animation: fadeIn 0.6s ease-out;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        @supports (-webkit-touch-callout: none) {
            /* iOS-specific optimizations */
            body {
                min-height: -webkit-fill-available;
            }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding-bottom: 2rem;
        }

        /* Ensure minimum touch target size for iOS */
        button, .checklist-item {
            min-height: 44px;
        }

        .screen {
            animation: fadeIn 0.6s ease-out;
        }

        .main-menu {
            animation: fadeIn 0.6s ease-out;
        }

        .menu-buttons {
            display: grid;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .menu-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.75rem;
            animation: slideUp 0.8s ease-out backwards;
            position: relative;
            overflow: hidden;
        }

        .menu-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: repeating-linear-gradient(
                90deg,
                var(--accent-primary) 0px,
                var(--accent-primary) 10px,
                var(--accent-secondary) 10px,
                var(--accent-secondary) 20px,
                var(--accent-teal) 20px,
                var(--accent-teal) 30px
            );
        }

        .menu-btn:nth-child(1) { animation-delay: 0.3s; }
        .menu-btn:nth-child(2) { animation-delay: 0.4s; }
        .menu-btn:nth-child(3) { animation-delay: 0.5s; }

        .menu-btn:hover {
            transform: translateY(-4px);
            border-color: var(--accent-primary);
            box-shadow: 0 8px 24px rgba(255, 140, 66, 0.3);
        }

        .menu-btn-icon {
            font-size: 3rem;
            line-height: 1;
        }

        .menu-btn-title {
            font-family: 'Righteous', sans-serif;
            font-size: 1.75rem;
            color: var(--text-primary);
            letter-spacing: 0.05em;
        }

        .menu-btn-desc {
            font-size: 0.938rem;
            color: var(--text-secondary);
        }

        .back-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.938rem;
            font-weight: 600;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            font-family: 'Archivo', sans-serif;
        }

        .back-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
            transform: translateX(-4px);
        }

        .subtitle {
            text-align: center;
            color: var(--text-secondary);
            font-size: 0.938rem;
            margin-top: 0.5rem;
            margin-bottom: 2rem;
        }

        .extras-info {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .extras-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        /* Flower Tracker Styles */
        .flower-container {
            display: flex;
            flex-direction: column;
            gap: 2rem;
        }

        .flower-display {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 3rem 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .flower-display::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 6px;
            background: repeating-linear-gradient(
                90deg,
                var(--accent-primary) 0px,
                var(--accent-primary) 10px,
                var(--accent-secondary) 10px,
                var(--accent-secondary) 20px,
                var(--accent-teal) 20px,
                var(--accent-teal) 30px
            );
        }

        .flower-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        .flower-count {
            font-family: 'Righteous', sans-serif;
            font-size: 5rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(3px 3px 0px rgba(251, 46, 1, 0.4));
            margin-bottom: 0.5rem;
        }

        .flower-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .flower-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .flower-btn {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            font-family: 'Archivo', sans-serif;
        }

        .flower-btn .btn-icon {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-primary);
        }

        .flower-btn .btn-text {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .decrease-btn:hover {
            border-color: var(--accent-red);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(251, 46, 1, 0.3);
        }

        .decrease-btn:hover .btn-icon,
        .decrease-btn:hover .btn-text {
            color: var(--accent-red);
        }

        .increase-btn:hover {
            border-color: var(--accent-teal);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(111, 203, 159, 0.3);
        }

        .increase-btn:hover .btn-icon,
        .increase-btn:hover .btn-text {
            color: var(--accent-teal);
        }

        .flower-info {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .flower-info p {
            color: var(--text-secondary);
            font-size: 0.875rem;
            line-height: 1.6;
        }

        header {
            text-align: center;
            margin-bottom: 3rem;
            animation: slideDown 0.8s ease-out;
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        h1 {
            font-family: 'Righteous', sans-serif;
            font-size: 4rem;
            letter-spacing: 0.05em;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            text-shadow: 0 0 40px rgba(255, 140, 66, 0.4);
            filter: drop-shadow(2px 2px 0px rgba(251, 46, 1, 0.3));
        }

        .streak-display {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            text-align: center;
            position: relative;
            overflow: hidden;
            animation: slideUp 0.8s ease-out 0.2s backwards;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .streak-display::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 14px;
            padding: 6px;
            background: repeating-linear-gradient(
                90deg,
                var(--accent-primary) 0px,
                var(--accent-primary) 10px,
                var(--accent-secondary) 10px,
                var(--accent-secondary) 20px,
                var(--accent-teal) 20px,
                var(--accent-teal) 30px
            );
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            pointer-events: none;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 1.5rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-family: 'Righteous', sans-serif;
            font-size: 4rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            filter: drop-shadow(3px 3px 0px rgba(251, 46, 1, 0.4));
        }

        .stat-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            font-weight: 600;
            margin-top: 0.5rem;
        }

        .stat-divider {
            width: 2px;
            height: 60px;
            background: var(--border);
        }

        .streak-number {
            font-family: 'Righteous', sans-serif;
            font-size: 6rem;
            line-height: 1;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
            filter: drop-shadow(3px 3px 0px rgba(251, 46, 1, 0.4));
        }

        .streak-label {
            font-size: 0.875rem;
            text-transform: uppercase;
            letter-spacing: 0.15em;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .last-completed {
            margin-top: 1rem;
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .section {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            animation: slideUp 0.8s ease-out backwards;
        }

        .section:nth-child(2) { animation-delay: 0.3s; }
        .section:nth-child(3) { animation-delay: 0.4s; }
        .section:nth-child(4) { animation-delay: 0.5s; }

        .section-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .section-title {
            font-family: 'Righteous', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            flex: 1;
        }

        .master-section {
            margin-bottom: 2rem;
        }

        .section-input {
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Righteous', sans-serif;
            font-size: 1.5rem;
            letter-spacing: 0.1em;
            outline: none;
            flex: 1;
        }

        .add-item-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--accent-primary);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            transition: all 0.3s ease;
        }

        .add-item-btn:hover {
            background: var(--accent-primary);
            color: var(--bg-dark);
            border-color: var(--accent-primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 140, 66, 0.4);
        }

        .checklist {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: var(--bg-dark);
            border: 1px solid var(--border);
            border-radius: 12px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .checklist-item:hover {
            border-color: var(--accent-primary);
            transform: translateX(4px);
        }

        .checklist-item.checked {
            border-color: var(--success);
            background: rgba(16, 185, 129, 0.05);
        }

        .checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .checklist-item.checked .checkbox {
            background: var(--success);
            border-color: var(--success);
        }

        .checkbox::after {
            content: '‚úì';
            color: white;
            font-weight: bold;
            opacity: 0;
            transform: scale(0);
            transition: all 0.3s ease;
        }

        .checklist-item.checked .checkbox::after {
            opacity: 1;
            transform: scale(1);
        }

        .item-text {
            flex: 1;
            font-size: 0.938rem;
            color: var(--text-primary);
        }

        .item-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            font-family: 'Archivo', sans-serif;
        }

        .delete-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0.25rem;
            opacity: 0;
            transition: all 0.3s ease;
            font-size: 1.25rem;
        }

        .checklist-item:hover .delete-btn {
            opacity: 1;
        }

        .delete-btn:hover {
            color: var(--accent-red);
        }

        .complete-day-btn {
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            border: none;
            color: var(--bg-dark);
            padding: 1.25rem 2rem;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1.125rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-family: 'Righteous', sans-serif;
            width: 100%;
            margin-top: 2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 20px rgba(255, 140, 66, 0.4);
            animation: slideUp 0.8s ease-out 0.6s backwards;
        }

        .complete-day-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(255, 140, 66, 0.5);
        }

        .complete-day-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .reset-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-top: 1rem;
            width: 100%;
            transition: all 0.3s ease;
        }

        .reset-btn:hover {
            border-color: var(--accent-red);
            color: var(--accent-red);
        }

        @media (max-width: 640px) {
            h1 {
                font-size: 3rem;
            }
            
            .stat-number {
                font-size: 3rem;
            }

            .menu-btn {
                padding: 1.5rem;
            }

            .menu-btn-icon {
                font-size: 2.5rem;
            }

            .menu-btn-title {
                font-size: 1.5rem;
            }

            .section {
                padding: 1.25rem;
            }

            .complete-day-btn {
                padding: 1rem 1.5rem;
                font-size: 1rem;
            }

            .flower-count {
                font-size: 4rem;
            }

            .flower-icon {
                font-size: 3rem;
            }

            .stats-grid {
                gap: 1rem;
            }

            .stat-divider {
                height: 50px;
            }
        }

        /* Specific optimizations for iPhone 13 Pro Max and similar */
        @media (max-width: 428px) and (min-height: 800px) {
            body {
                padding: 1rem 0.75rem;
            }

            h1 {
                font-size: 2.75rem;
            }

            .streak-display {
                padding: 1.5rem;
                margin-bottom: 1.5rem;
            }

            .stat-number {
                font-size: 2.5rem;
            }

            .menu-buttons {
                gap: 1.25rem;
            }

            .checklist-item {
                padding: 0.875rem;
                font-size: 1rem;
            }

            .item-input {
                font-size: 1rem;
            }

            .flower-count {
                font-size: 3.5rem;
            }

            .flower-display {
                padding: 2rem 1.5rem;
            }

            .stats-grid {
                gap: 0.75rem;
            }

            .stat-divider {
                height: 40px;
            }
        }

        /* Confetti canvas */
        #confettiCanvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 9999;
            display: none;
        }
    </style>
</head>
<body>
    <canvas id="confettiCanvas"></canvas>
    <div class="container">
        <!-- Main Menu Screen -->
        <div id="mainMenu" class="main-menu">
            <header>
                <h1>MOMENTUM MACHINE</h1>
            </header>

            <div class="streak-display">
                <div class="stats-grid">
                    <div class="stat-item">
                        <div class="stat-number" id="menuStreakNumber">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                    <div class="stat-divider"></div>
                    <div class="stat-item">
                        <div class="stat-number" id="menuFlowerCount">0</div>
                        <div class="stat-label">üå∏ Flowers</div>
                    </div>
                </div>
                <div class="last-completed" id="menuLastCompleted">Never completed</div>
            </div>

            <div class="menu-buttons">
                <button class="menu-btn master-btn" id="masterListBtn">
                    <div class="menu-btn-icon">üìã</div>
                    <div class="menu-btn-title">Master List</div>
                    <div class="menu-btn-desc">Your daily essential tasks</div>
                </button>
                
                <button class="menu-btn extras-btn" id="dailyExtrasBtn">
                    <div class="menu-btn-icon">‚ú®</div>
                    <div class="menu-btn-title">Daily Extras</div>
                    <div class="menu-btn-desc">Side quests</div>
                </button>

                <button class="menu-btn flower-btn" id="flowerTrackerBtn">
                    <div class="menu-btn-icon">üåª</div>
                    <div class="menu-btn-title">Flower Tracker</div>
                    <div class="menu-btn-desc">Track your garden</div>
                </button>
            </div>

            <button class="reset-btn" id="menuResetBtn">Reset Streak</button>
        </div>

        <!-- Master List Screen -->
        <div id="masterListScreen" class="screen" style="display: none;">
            <header>
                <button class="back-btn" id="backFromMaster">‚Üê Back</button>
                <h1>MASTER LIST</h1>
                <p class="subtitle">Your daily essential tasks - complete all to build your streak</p>
            </header>

            <div class="section master-section">
                <div class="section-header">
                    <h2 class="section-title">Daily Tasks</h2>
                    <button class="add-item-btn" id="addMasterItem">+ Add Task</button>
                </div>
                <div class="checklist" id="masterChecklist"></div>
            </div>

            <button class="complete-day-btn" id="completeDayBtn">Complete Day</button>
        </div>

        <!-- Daily Extras Screen -->
        <div id="dailyExtrasScreen" class="screen" style="display: none;">
            <header>
                <button class="back-btn" id="backFromExtras">‚Üê Back</button>
                <h1>DAILY EXTRAS</h1>
            </header>

            <div class="section">
                <div class="section-header">
                    <h2 class="section-title">Today's Extra Tasks</h2>
                    <button class="add-item-btn" data-section="extras">+ Add Item</button>
                </div>
                <div class="checklist" data-section="extras"></div>
            </div>

            <div class="extras-info">
                <p>‚ú® These tasks are just for today and won't affect your streak</p>
                <p>üóëÔ∏è All items will be cleared at midnight</p>
            </div>
        </div>

        <!-- Flower Tracker Screen -->
        <div id="flowerTrackerScreen" class="screen" style="display: none;">
            <header>
                <button class="back-btn" id="backFromFlower">‚Üê Back</button>
                <h1>FLOWER TRACKER</h1>
            </header>

            <div class="flower-container">
                <div class="flower-display">
                    <div class="flower-icon">üå∫</div>
                    <div class="flower-count" id="flowerCountDisplay">0</div>
                    <div class="flower-label">Flowers</div>
                </div>

                <div class="flower-controls">
                    <button class="flower-btn decrease-btn" id="decreaseFlower">
                        <span class="btn-icon">‚àí</span>
                        <span class="btn-text">Remove</span>
                    </button>
                    <button class="flower-btn increase-btn" id="increaseFlower">
                        <span class="btn-icon">+</span>
                        <span class="btn-text">Add</span>
                    </button>
                </div>

                <div class="flower-info">
                    <p>ü™¥ Track your flower usage</p>
                    <p>üå± Use + and ‚àí to adjust your count</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize app state
        let appState = {
            masterItems: [],
            dailyExtras: [],
            streak: 0,
            flowerCount: 0,
            lastCompletedDate: null,
            todayCompleted: false,
            lastExtrasResetDate: null
        };

        let currentScreen = 'menu'; // 'menu', 'master', 'extras'

        // Navigation functions
        function showScreen(screen) {
            document.getElementById('mainMenu').style.display = 'none';
            document.getElementById('masterListScreen').style.display = 'none';
            document.getElementById('dailyExtrasScreen').style.display = 'none';
            document.getElementById('flowerTrackerScreen').style.display = 'none';
            
            if (screen === 'menu') {
                document.getElementById('mainMenu').style.display = 'block';
                updateMenuUI();
            } else if (screen === 'master') {
                document.getElementById('masterListScreen').style.display = 'block';
                updateMasterListUI();
            } else if (screen === 'extras') {
                document.getElementById('dailyExtrasScreen').style.display = 'block';
                updateExtrasUI();
            } else if (screen === 'flower') {
                document.getElementById('flowerTrackerScreen').style.display = 'block';
                updateFlowerUI();
            }
            
            currentScreen = screen;
        }

        // Load state from localStorage
        function loadState() {
            try {
                const saved = localStorage.getItem('momentumMachineState');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    appState = { ...appState, ...parsed };
                    
                    // Check if we need to reset today's completion status
                    const today = new Date().toDateString();
                    const lastCompleted = appState.lastCompletedDate ? new Date(appState.lastCompletedDate).toDateString() : null;
                    
                    if (lastCompleted !== today) {
                        // New day - reset all checkboxes and today's completion
                        appState.todayCompleted = false;
                        appState.masterItems.forEach(item => item.checked = false);
                        
                        // Check if streak should be broken
                        if (lastCompleted) {
                            const lastDate = new Date(appState.lastCompletedDate);
                            const todayDate = new Date();
                            todayDate.setHours(0, 0, 0, 0);
                            lastDate.setHours(0, 0, 0, 0);
                            
                            const diffTime = todayDate - lastDate;
                            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                            
                            // If more than 1 day has passed, break the streak
                            if (diffDays > 1) {
                                appState.streak = 0;
                            }
                        }
                    }

                    // Check if we need to reset daily extras
                    const lastExtrasReset = appState.lastExtrasResetDate ? new Date(appState.lastExtrasResetDate).toDateString() : null;
                    if (lastExtrasReset !== today) {
                        // Clear all daily extras
                        appState.dailyExtras = [];
                        appState.lastExtrasResetDate = new Date().toISOString();
                    }
                }
            } catch (e) {
                console.error('Failed to load state:', e);
            }
        }

        // Save state to localStorage
        function saveState() {
            try {
                localStorage.setItem('momentumMachineState', JSON.stringify(appState));
            } catch (e) {
                console.error('Failed to save state:', e);
            }
        }

        // Update Menu UI
        function updateMenuUI() {
            document.getElementById('menuStreakNumber').textContent = appState.streak;
            document.getElementById('menuFlowerCount').textContent = appState.flowerCount;
            
            const lastCompletedEl = document.getElementById('menuLastCompleted');
            if (appState.lastCompletedDate) {
                const date = new Date(appState.lastCompletedDate);
                const today = new Date().toDateString();
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                
                if (date.toDateString() === today) {
                    lastCompletedEl.textContent = 'Completed today ‚úì';
                } else if (date.toDateString() === yesterday) {
                    lastCompletedEl.textContent = 'Last completed yesterday';
                } else {
                    lastCompletedEl.textContent = `Last completed ${date.toLocaleDateString()}`;
                }
            } else {
                lastCompletedEl.textContent = 'Never completed';
            }
        }

        // Update Master List UI
        function updateMasterListUI() {
            const container = document.getElementById('masterChecklist');
            container.innerHTML = '';
            
            appState.masterItems.forEach((item, itemIdx) => {
                const itemEl = createChecklistItem(item, itemIdx, 'master');
                container.appendChild(itemEl);
            });

            // Update complete day button
            updateCompleteDayButton();
        }

        // Update Daily Extras UI
        function updateExtrasUI() {
            const container = document.querySelector('#dailyExtrasScreen .checklist[data-section="extras"]');
            container.innerHTML = '';
            
            appState.dailyExtras.forEach((item, itemIdx) => {
                const itemEl = createChecklistItem(item, itemIdx, 'extras');
                container.appendChild(itemEl);
            });
        }

        // Update Flower UI
        function updateFlowerUI() {
            document.getElementById('flowerCountDisplay').textContent = appState.flowerCount;
        }

        // Create checklist item element
        function createChecklistItem(item, itemIdx, type) {
            const div = document.createElement('div');
            div.className = `checklist-item ${item.checked ? 'checked' : ''}`;
            
            div.innerHTML = `
                <div class="checkbox"></div>
                <input type="text" class="item-input" value="${item.text}" data-item="${itemIdx}" data-type="${type}">
                <button class="delete-btn" data-item="${itemIdx}" data-type="${type}">√ó</button>
            `;
            
            // Toggle checkbox
            div.addEventListener('click', (e) => {
                if (e.target.classList.contains('item-input') || e.target.classList.contains('delete-btn')) {
                    return;
                }
                item.checked = !item.checked;
                saveState();
                if (type === 'master') {
                    updateMasterListUI();
                } else {
                    updateExtrasUI();
                }
            });
            
            // Edit item text
            const input = div.querySelector('.item-input');
            input.addEventListener('change', (e) => {
                item.text = e.target.value;
                saveState();
            });
            
            // Delete item
            const deleteBtn = div.querySelector('.delete-btn');
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (type === 'master') {
                    appState.masterItems.splice(itemIdx, 1);
                    updateMasterListUI();
                } else {
                    appState.dailyExtras.splice(itemIdx, 1);
                    updateExtrasUI();
                }
                saveState();
            });
            
            return div;
        }

        // Add item to master list
        document.getElementById('addMasterItem').addEventListener('click', () => {
            appState.masterItems.push({
                text: 'New task',
                checked: false
            });
            saveState();
            updateMasterListUI();
        });

        // Add item to extras
        document.querySelectorAll('.add-item-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const sectionAttr = e.target.dataset.section;
                
                if (sectionAttr === 'extras') {
                    appState.dailyExtras.push({
                        text: 'New task',
                        checked: false
                    });
                    saveState();
                    updateExtrasUI();
                }
            });
        });

        // Check if all master list items are checked
        function allItemsChecked() {
            if (appState.masterItems.length === 0) return false;
            return appState.masterItems.every(item => item.checked);
        }

        // Update complete day button state
        function updateCompleteDayButton() {
            const btn = document.getElementById('completeDayBtn');
            const canComplete = allItemsChecked() && !appState.todayCompleted;
            btn.disabled = !canComplete;
            
            if (appState.todayCompleted) {
                btn.textContent = 'Day Already Completed ‚úì';
            } else if (allItemsChecked()) {
                btn.textContent = 'Complete Day';
            } else {
                btn.textContent = 'Complete All Tasks First';
            }
        }

        // Complete day
        document.getElementById('completeDayBtn').addEventListener('click', () => {
            if (!allItemsChecked() || appState.todayCompleted) return;
            
            const today = new Date();
            const todayStr = today.toDateString();
            const lastCompletedStr = appState.lastCompletedDate ? new Date(appState.lastCompletedDate).toDateString() : null;
            
            if (lastCompletedStr) {
                const yesterday = new Date(Date.now() - 86400000).toDateString();
                if (lastCompletedStr === yesterday) {
                    appState.streak++;
                } else if (lastCompletedStr !== todayStr) {
                    appState.streak = 1;
                }
            } else {
                appState.streak = 1;
            }
            
            appState.lastCompletedDate = today.toISOString();
            appState.todayCompleted = true;
            
            saveState();
            updateMasterListUI();
            
            // Confetti celebration!
            launchConfetti();
        });

        // Confetti animation
        function launchConfetti() {
            const canvas = document.getElementById('confettiCanvas');
            const ctx = canvas.getContext('2d');
            
            canvas.style.display = 'block';
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            const confettiCount = 500;
            const confetti = [];
            const colors = ['#ff8c42', '#ffb865', '#6fcb9f', '#ffe28a', '#fb2e01'];
            
            // Random encouraging phrases
            const phrases = [
                'good stuff broheim',
                'another juan',
                'only 29,200 to go!',
                'haters gon hate',
                'players gon play',
                '67',
                'Jesus is thy saviour',
                'absolutely legendary',
                'crushing it king',
                'built different fr',
                'momentum acquired',
                'we so back',
                'unstoppable force detected',
                'simply built better',
                'another W',
                'no days off mentality',
                'lock in szn',
                'godspeed soldier',
                'the grind continues',
                'real ones know',
                'too powerful',
                'main character energy',
                'unfathomably based',
                'certified banger',
                'peak performance unlocked',
                'excellence is habit',
                'stay dangerous',
                'different breed',
                'touch grass? nah touch goals',
                'sigma grindset activated',
                'that\'s what i\'m talking about',
                'absolute cinema',
                'you love to see it',
                'nothing but net',
                'certified classic',
                'hall of fame behavior',
                'goated with the sauce',
                'no cap detected',
                'rent free in success\'s head',
                'the prophecy continues',
                'built by wolves',
                'raised by machines',
                'living rent free',
                'simply unmatched',
                'actual demon time',
                'certified menace',
                'can\'t be stopped won\'t be stopped',
                'the legend grows',
                'generational talent',
                'caught in 4k being awesome',
                'touched by greatness',
                'real recognizes real',
                'another day another slay',
                'vibes immaculate',
                'energy unmatched',
                'aura radiating',
                'the streak lives on'
            ];
            
            // Pick random phrase
            const randomPhrase = phrases[Math.floor(Math.random() * phrases.length)];
            
            class ConfettiPiece {
                constructor() {
                    this.x = Math.random() * canvas.width;
                    this.y = -20;
                    this.size = Math.random() * 8 + 4;
                    this.speedY = Math.random() * 1.5 + 1; // Slower drop
                    this.speedX = Math.random() * 2 - 1;
                    this.color = colors[Math.floor(Math.random() * colors.length)];
                    this.rotation = Math.random() * 360;
                    this.rotationSpeed = Math.random() * 10 - 5;
                    this.gravity = 0.03; // Reduced gravity for slower fall
                }
                
                update() {
                    this.y += this.speedY;
                    this.x += this.speedX;
                    this.speedY += this.gravity;
                    this.rotation += this.rotationSpeed;
                }
                
                draw() {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(this.rotation * Math.PI / 180);
                    ctx.fillStyle = this.color;
                    ctx.fillRect(-this.size / 2, -this.size / 2, this.size, this.size);
                    ctx.restore();
                }
            }
            
            // Create confetti pieces
            for (let i = 0; i < confettiCount; i++) {
                confetti.push(new ConfettiPiece());
            }
            
            // Animation loop
            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                
                let activeConfetti = 0;
                confetti.forEach(piece => {
                    piece.update();
                    piece.draw();
                    if (piece.y < canvas.height) {
                        activeConfetti++;
                    }
                });
                
                if (activeConfetti > 0) {
                    requestAnimationFrame(animate);
                } else {
                    canvas.style.display = 'none';
                }
            }
            
            animate();
            
            // Show the random phrase
            setTimeout(() => {
                alert('üéâ ' + randomPhrase + '\n\nStreak: ' + appState.streak + ' days!');
                showScreen('menu');
            }, 1000);
        }

        // Reset streak
        document.getElementById('menuResetBtn').addEventListener('click', () => {
            if (confirm('Are you sure you want to reset your streak?')) {
                appState.streak = 0;
                appState.lastCompletedDate = null;
                appState.todayCompleted = false;
                saveState();
                updateMenuUI();
            }
        });

        // Navigation buttons
        document.getElementById('masterListBtn').addEventListener('click', () => {
            showScreen('master');
        });

        document.getElementById('dailyExtrasBtn').addEventListener('click', () => {
            showScreen('extras');
        });

        document.getElementById('flowerTrackerBtn').addEventListener('click', () => {
            showScreen('flower');
        });

        document.getElementById('backFromMaster').addEventListener('click', () => {
            showScreen('menu');
        });

        document.getElementById('backFromExtras').addEventListener('click', () => {
            showScreen('menu');
        });

        document.getElementById('backFromFlower').addEventListener('click', () => {
            showScreen('menu');
        });

        // Flower tracker controls
        document.getElementById('increaseFlower').addEventListener('click', () => {
            appState.flowerCount++;
            saveState();
            updateFlowerUI();
            updateMenuUI();
        });

        document.getElementById('decreaseFlower').addEventListener('click', () => {
            if (appState.flowerCount > 0) {
                appState.flowerCount--;
                saveState();
                updateFlowerUI();
                updateMenuUI();
            }
        });

        // Initialize
        loadState();
        showScreen('menu');
    </script>
</body>
</html>
